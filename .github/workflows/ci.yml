name: CI Pipeline
on: [ push ]
jobs:
  Test:
    runs-on: ubuntu-latest
    name: CI on ubuntu-latest with PHP 8.1
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: "Check out repository code"
        uses: actions/checkout@v3
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - name: "Setup environment"
        run: |
          make setup_test_environment php_version=8.1
      - name: "Static Analysis"
        run: |
          make phpstan
          make psalm
      - name: "Unit Testing"
        run: |
          make phpunit
      - name: "Mutation Testing"
        run: |
          make infection
  Deploy:
    runs-on: ubuntu-latest
    needs: Test
    if: github.ref == 'refs/heads/main'
    steps:
      - name: "Check out repository code"
        uses: actions/checkout@v3
      - name: Setup environment
        run: make setup_prod_environment php_version=8.1
      - name: Start application
        run: make start
      - name: Build static site
        run: make build_static_site
      - name: Deploy website
        run: |
          cp -R ${{ github.workspace }}/builds/$(ls ${{ github.workspace }}/builds | sort -r | head -n 1) ${{ github.workspace }}/builds/latest
      - name: copy file via ssh password
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: "builds/latest/"
          target: "/website"
          strip_components: 1
          rm: true