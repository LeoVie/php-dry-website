name: CI Pipeline
on: [ push ]
jobs:
  Test:
    runs-on: ubuntu-latest
    name: CI on ubuntu-latest with PHP 8.1
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: "Check out repository code"
        uses: actions/checkout@v3
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - name: "Setup environment"
        run: |
          make setup_test_environment php_version=8.1
      - name: "Static Analysis"
        run: |
          make phpstan
          make psalm
      - name: "Unit Testing"
        run: |
          make phpunit
      - name: "Mutation Testing"
        run: |
          make infection
  Deploy:
    runs-on: ubuntu-latest
    needs: Test
    if: github.ref == 'refs/heads/main'
    steps:
      - name: "Check out repository code"
        uses: actions/checkout@v3
      - name: Install linux dependencies
        run: sudo apt install sshpass
      - name: Setup environment
        run: make setup_prod_environment php_version=8.1
      - name: Start application
        run: make start
      - name: Build static site
        run: make build_static_site
      - name: Deploy website
        run: |
          cd builds/$(ls ./builds | sort -r | head -n 1)
          echo "Deploying $(ls ./builds | sort -r | head -n 1)"
          sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -r -o user=${{ secrets.SSH_USERNAME }}@php-dry.org ./* ssh.strato.de:.